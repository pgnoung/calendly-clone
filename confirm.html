<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á | Calendly Clone</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="confirmation-page">
    <div class="confirmation-card">
      <div class="confirmation-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
          <path d="M22 4L12 14.01l-3-3"/>
        </svg>
      </div>

      <h1 class="confirmation-title">‡∏à‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h1>
      <p class="confirmation-message">
        ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
      </p>

      <div class="confirmation-details" id="booking-details">
        <!-- Details will be rendered by JS -->
        <div class="loading"><div class="spinner"></div></div>
      </div>

      <div id="meeting-link-section" style="display: none;">
        <a href="#" id="meeting-link" target="_blank" class="btn btn-primary btn-lg btn-block mb-md">
          üìπ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° Google Meet
        </a>
      </div>

      <div class="d-flex gap-md" style="justify-content: center;">
        <a href="book.html" class="btn btn-secondary">‡∏à‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</a>
        <button onclick="addToCalendar()" class="btn btn-outline">
          üìÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
        </button>
      </div>

      <div id="recurring-info" style="display: none; margin-top: 1.5rem; padding: 1rem; background: var(--primary-light); border-radius: 0.5rem;">
        <p style="margin: 0; color: var(--primary);">
          üîÑ ‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ã‡πâ‡∏≥ <span id="recurring-count"></span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        </p>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const bookingData = sessionStorage.getItem('lastBooking');

      if (!bookingData) {
        document.getElementById('booking-details').innerHTML = `
          <p class="text-muted text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
        `;
        return;
      }

      const data = JSON.parse(bookingData);
      const booking = data.booking;
      const eventType = data.eventType;
      const member = data.member;

      // Format date
      const date = new Date(data.date);
      const dateStr = `${THAI_DAYS[date.getDay()]}‡∏ó‡∏µ‡πà ${date.getDate()} ${THAI_MONTHS[date.getMonth()]} ${date.getFullYear() + 543}`;

      // Location info
      const locationInfo = CONFIG.LOCATION_TYPES[eventType?.location_type] || {};

      // Render details
      document.getElementById('booking-details').innerHTML = `
        <div class="detail-row">
          <span class="detail-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</span>
          <span class="detail-value">${eventType?.name || '-'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
          <span class="detail-value">${member?.name || '-'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
          <span class="detail-value">${dateStr}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‡πÄ‡∏ß‡∏•‡∏≤</span>
          <span class="detail-value">${data.time} (${eventType?.duration || 30} ‡∏ô‡∏≤‡∏ó‡∏µ)</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</span>
          <span class="detail-value">${locationInfo.icon || ''} ${locationInfo.label || '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå'}</span>
        </div>
        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--gray-200);">
        <div class="detail-row">
          <span class="detail-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</span>
          <span class="detail-value">${data.guest_name}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span>
          <span class="detail-value">${data.guest_email}</span>
        </div>
        ${data.guest_phone ? `
          <div class="detail-row">
            <span class="detail-label">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span>
            <span class="detail-value">${data.guest_phone}</span>
          </div>
        ` : ''}
      `;

      // Show meeting link if available
      if (booking?.meeting_link) {
        document.getElementById('meeting-link-section').style.display = 'block';
        document.getElementById('meeting-link').href = booking.meeting_link;
      }

      // Show recurring info
      if (data.isRecurring && data.recurringOptions) {
        document.getElementById('recurring-info').style.display = 'block';
        document.getElementById('recurring-count').textContent = data.recurringOptions.occurrences;
      }

      // Store for calendar export
      window.bookingForCalendar = {
        title: `${eventType?.name || '‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢'} ‡∏Å‡∏±‡∏ö ${member?.name || ''}`,
        date: data.date,
        time: data.time,
        duration: eventType?.duration || 30,
        description: data.notes || '',
        location: booking?.meeting_link || '',
      };
    });

    function addToCalendar() {
      const booking = window.bookingForCalendar;
      if (!booking) return;

      // Create ICS file content
      const startDate = new Date(`${booking.date}T${booking.time}`);
      const endDate = new Date(startDate.getTime() + booking.duration * 60000);

      const formatDate = (d) => {
        return d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };

      const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CalendlyClone//EN
BEGIN:VEVENT
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:${booking.title}
DESCRIPTION:${booking.description}
LOCATION:${booking.location}
END:VEVENT
END:VCALENDAR`;

      // Download ICS file
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'booking.ics';
      link.click();
    }
  </script>
</body>
</html>
